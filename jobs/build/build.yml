---
- name: Install missing 
  apt:
    pkg:
      - gcc
      - make
      - libiperf0
      - lksctp-tools
      - libssl-dev
      - openssl
- name: Let's try to get SCTP enabled... 
  shell:
    cmd: modprobe sctp
  ignore_errors: yes
- name: Lets make sure we get iperf installed
  block:
    - name: Get iperf3
      ansible.builtin.get_url:
        url: "{{ iperf.url }}"
        dest: /opt/iperf3.tar.gz
    - name: Ensure iperf dir exists
      ansible.builtin.file:
        path: /opt/iperf3
        state: directory
    - name: Explode iperf3
      ansible.builtin.shell:
        cmd: tar -xvzf iperf3.tar.gz -C /opt/iperf3 --strip-components=1
        chdir: /opt/
    - name: Configure iperf3
      ansible.builtin.shell:
        cmd: ./configure 
        chdir: /opt/iperf3
    - name: Install iperf3
      community.general.make:
        chdir: /opt/iperf3
        target: install
        params:
          NUM_THREADS: "{{ build.threads }}"
    - name: Remove the lesser!
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /usr/bin/iperf3
        - /usr/local/bin/iperf3
    - name: Crown our built binary!
      ansible.builtin.file:
        src: /opt/iperf3/src/iperf3
        dest: /usr/local/bin/iperf3
        mode: '0555'
        owner: root
        group: root
        state: link
  rescue:
    - name: Installing from repo as backup option
      ansible.builtin.apt:
        pkg: iperf3

- name: Copy sudoers
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/data/sudoers"
    dest: /etc/sudoers

- name: Generate Key for Server / Client
  ansible.builtin.shell:
    cmd: openssl req  -nodes -newkey rsa:4096 -keyout private.pem -out public.pem  -subj "/C=US/ST=TX/L=Dallas/O=My Inc/OU=DevOps/CN=www.example.com/emailAddress=dev@www.example.com"
    chdir: /etc/ssl
  args: 
    creates: /etc/ssl/private.pem

- name: Ownership priv
  ansible.builtin.file:
    path: /etc/ssl/private.pem
    mode: "0500"
    group: "{{ run.user }}"
    user: "{{ run.user }}"

- name: Ownership pub
  ansible.builtin.file:
    path: /etc/ssl/public.pem
    mode: "0544"
    group: "{{ run.user }}"
    user: "{{ run.user }}"